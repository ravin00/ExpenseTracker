name: Promote Images To Dev

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: promote-dev-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  promote-dev:
    name: Update Dev Image Tags (GitOps)
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install yq
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Update dev tags to immutable SHA
        shell: bash
        run: |
          set -euo pipefail
          FILE="infra/k8s/charts/spendwise/values-dev.yaml"
          SHA="${{ github.event.workflow_run.head_sha }}"

          yq -i ".authService.tag = \"auth-service-${SHA}\"" "$FILE"
          yq -i ".expenseService.tag = \"expense-service-${SHA}\"" "$FILE"
          yq -i ".categoryService.tag = \"category-service-${SHA}\"" "$FILE"
          yq -i ".budgetService.tag = \"budget-service-${SHA}\"" "$FILE"
          yq -i ".savingsGoalService.tag = \"savings-goal-service-${SHA}\"" "$FILE"
          yq -i ".analyticsService.tag = \"analytics-service-${SHA}\"" "$FILE"

      - name: Create PR for dev promotion
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/promote-dev-${{ github.event.workflow_run.head_sha }}
          base: main
          title: "chore(gitops): promote dev images for ${{ github.event.workflow_run.head_sha }}"
          commit-message: "chore(gitops): update dev image tags to ${{ github.event.workflow_run.head_sha }}"
          body: |
            Updates `/infra/k8s/charts/spendwise/values-dev.yaml` to immutable image tags built from commit `${{ github.event.workflow_run.head_sha }}`.

            This is a GitOps promotion PR generated after successful image build.
          labels: |
            gitops
            deployment

      - name: Report PR result
        shell: bash
        env:
          PR_OPERATION: ${{ steps.cpr.outputs.pull-request-operation }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          set -euo pipefail
          echo "pull-request-operation=${PR_OPERATION:-none}"
          echo "pull-request-number=${PR_NUMBER:-none}"
          echo "pull-request-url=${PR_URL:-none}"

          {
            echo "### Dev Promotion PR"
            echo ""
            echo "- operation: \`${PR_OPERATION:-none}\`"
            echo "- number: \`${PR_NUMBER:-none}\`"
            if [[ -n "${PR_URL:-}" ]]; then
              echo "- url: ${PR_URL}"
            else
              echo "- url: none (likely no changes to commit)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
